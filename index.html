<!DOCTYPE html>
<html lang="pt-pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minha Casa Inteligente</title>
    <!-- √çcone para navegadores e instala√ß√£o PWA -->
    <link rel="icon" type="image/png" href="icon.png">
    <link rel="apple-touch-icon" href="icon.png">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/dexie@latest/dist/dexie.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#10b981">
    <style>
        .fade-enter-active, .fade-leave-active { transition: opacity 0.3s ease; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
        [v-cloak] { display: none; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        .chat-bubble { max-width: 85%; }
        @keyframes bounce-short {
            0%, 100% { transform: translate(-50%, 0); }
            50% { transform: translate(-50%, -5px); }
        }
        .animate-bounce-short { animation: bounce-short 2s infinite; }
    </style>
</head>
<body class="bg-gray-100 font-sans text-slate-800">
    <div id="app" v-cloak class="min-h-screen flex flex-col pb-24">
        
        <!-- API Key Setup Overlay -->
        <transition name="fade">
            <div v-if="showApiOverlay" @click.self="showApiOverlay = false" class="fixed inset-0 bg-emerald-900 bg-opacity-90 z-[100] flex items-center justify-center p-6 backdrop-blur-sm">
                <div class="bg-white rounded-3xl p-8 w-full max-w-md shadow-2xl text-center relative">
                    <button @click="showApiOverlay = false" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 p-2"><i data-lucide="x"></i></button>
                    <div class="bg-emerald-100 w-16 h-16 rounded-2xl flex items-center justify-center mx-auto mb-6 text-emerald-600"><i data-lucide="key"></i></div>
                    <h2 class="text-2xl font-bold text-slate-800 mb-2 text-emerald-800">Configura√ß√£o IA</h2>
                    <p class="text-gray-500 mb-6 text-sm">Insira a sua Google Gemini API Key para ativar as fun√ß√µes inteligentes.</p>
                    <input v-model="tempApiKey" type="password" placeholder="Chave da API..." class="w-full border-2 border-gray-100 p-4 rounded-xl mb-4 focus:border-emerald-500 outline-none transition">
                    <button @click="saveApiKey" class="w-full bg-emerald-600 text-white font-bold py-4 rounded-xl hover:bg-emerald-700 transition shadow-lg uppercase tracking-widest text-sm">Salvar e Iniciar</button>
                </div>
            </div>
        </transition>

        <!-- Header -->
        <header class="bg-white border-b border-gray-200 p-4 sticky top-0 z-10">
            <div class="max-w-4xl mx-auto flex justify-between items-center">
                <div class="flex items-center gap-2">
                    <div class="bg-emerald-500 p-2 rounded-lg text-white shadow-md shadow-emerald-100"><i data-lucide="home" class="w-5 h-5"></i></div>
                    <h1 class="text-xl font-bold text-slate-700 tracking-tight">Minha Casa</h1>
                </div>
                <div class="flex gap-2">
                    <button @click="exportData" class="p-2 text-gray-400 hover:text-emerald-600 transition"><i data-lucide="download"></i></button>
                    <button @click="showSettings = true" class="p-2 text-gray-400 hover:text-emerald-600 transition"><i data-lucide="settings"></i></button>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="flex-grow p-4 max-w-4xl mx-auto w-full">
            
            <!-- 1. DASHBOARD TAB -->
            <section v-if="currentTab === 'home'" class="space-y-6">
                <div class="bg-white p-6 rounded-3xl border border-gray-200 shadow-sm flex items-center gap-4">
                    <div class="relative w-16 h-16 flex items-center justify-center">
                         <svg class="w-full h-full transform -rotate-90">
                            <circle cx="32" cy="32" r="28" stroke="currentColor" stroke-width="6" fill="transparent" class="text-gray-100" />
                            <circle cx="32" cy="32" r="28" stroke="currentColor" stroke-width="6" fill="transparent" :stroke-dasharray="175" :stroke-dashoffset="175 - (175 * houseHealth / 100)" class="text-emerald-500" />
                        </svg>
                        <span class="absolute text-xs font-black">{{ houseHealth }}%</span>
                    </div>
                    <div>
                        <h3 class="font-bold text-slate-700">Sa√∫de da Casa</h3>
                        <p class="text-xs text-gray-500">{{ houseHealthMessage }}</p>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="bg-white p-5 rounded-3xl border border-gray-200 shadow-sm">
                        <div class="flex items-center gap-2 mb-4 text-red-500">
                            <i data-lucide="alert-circle" class="w-5 h-5"></i>
                            <h3 class="font-bold uppercase text-xs tracking-wider">Prioridade Alta</h3>
                        </div>
                        <div v-if="highPriorityItems.length" class="space-y-3">
                            <div v-for="item in highPriorityItems.slice(0, 3)" :key="item.id" class="flex items-center justify-between text-sm border-b border-gray-50 pb-2">
                                <span class="truncate pr-2">{{ item.title }}</span>
                                <span class="text-[9px] bg-red-100 text-red-700 px-2 py-0.5 rounded-full font-bold uppercase">{{ item.type }}</span>
                            </div>
                        </div>
                        <p v-else class="text-gray-400 text-sm italic">Nada pendente.</p>
                    </div>

                    <div class="bg-white p-5 rounded-3xl border border-gray-200 shadow-sm">
                        <div class="flex items-center gap-2 mb-4 text-emerald-600">
                            <i data-lucide="calendar" class="w-5 h-5"></i>
                            <h3 class="font-bold uppercase text-xs tracking-wider">Pr√≥ximos Prazos</h3>
                        </div>
                        <div v-if="upcomingItems.length" class="space-y-3">
                            <div v-for="item in upcomingItems.slice(0, 3)" :key="item.id" class="flex items-center justify-between text-sm border-b border-gray-50 pb-2">
                                <span class="truncate pr-2">{{ item.title }}</span>
                                <span class="text-xs font-medium text-emerald-600">{{ formatDateShort(item.date) }}</span>
                            </div>
                        </div>
                        <p v-else class="text-gray-400 text-sm italic">Agenda livre.</p>
                    </div>

                    <div class="bg-emerald-600 p-5 rounded-3xl shadow-lg shadow-emerald-100 text-white md:col-span-2 flex justify-between items-center transition active:scale-95 cursor-pointer" @click="currentTab = 'shopping'">
                        <div>
                            <h3 class="font-bold text-lg text-white">Lista de Compras</h3>
                            <p class="text-emerald-100 text-sm">{{ shoppingList.filter(i => !i.done).length }} itens por comprar</p>
                        </div>
                        <div class="bg-white/20 p-3 rounded-2xl">
                            <i data-lucide="chevron-right"></i>
                        </div>
                    </div>
                </div>
            </section>

            <!-- 2. SHOPPING TAB -->
            <section v-if="currentTab === 'shopping'" class="space-y-4">
                <div class="bg-white p-4 rounded-2xl border border-gray-200 shadow-sm">
                    <form @submit.prevent="addItem" class="flex gap-2">
                        <input v-model="newItem" type="text" placeholder="O que comprar?" class="flex-grow bg-gray-50 border-none p-3 rounded-xl outline-none focus:ring-2 focus:ring-emerald-100 transition" required>
                        <button type="submit" class="bg-emerald-600 text-white px-5 rounded-xl hover:bg-emerald-700 transition font-bold">+</button>
                    </form>
                    <div class="flex flex-wrap gap-2 mt-4">
                        <button @click="categorizeAll" :disabled="loadingAI" class="flex-grow bg-emerald-50 border border-emerald-100 text-emerald-700 px-4 py-2.5 rounded-xl text-xs font-black uppercase tracking-tighter flex items-center justify-center gap-2 transition disabled:opacity-50">
                            <span v-if="loadingAI" class="animate-spin">‚Üª</span>
                            <i v-else data-lucide="sparkles" class="w-3.5 h-3.5"></i> ORGANIZAR COM IA
                        </button>
                        <button @click="suggestMissingItems" :disabled="loadingAI" class="flex-grow bg-amber-50 border border-amber-100 text-amber-700 px-4 py-2.5 rounded-xl text-xs font-black uppercase tracking-tighter flex items-center justify-center gap-2 transition">
                            <i data-lucide="lightbulb" class="w-3.5 h-3.5"></i> O QUE FALTA?
                        </button>
                        <button @click="suggestRecipes" :disabled="loadingAI" class="flex-grow bg-blue-50 border border-blue-100 text-blue-700 px-4 py-2.5 rounded-xl text-xs font-black uppercase tracking-tighter flex items-center justify-center gap-2 transition">
                            <i data-lucide="utensils" class="w-3.5 h-3.5"></i> RECEITAS IA
                        </button>
                    </div>
                </div>

                <div v-for="(items, category) in categorizedShopping" :key="category">
                    <h3 class="text-[10px] font-black text-gray-400 uppercase tracking-[0.2em] mb-2 mt-4 px-2">{{ category }}</h3>
                    <div class="space-y-2">
                        <div v-for="item in items" :key="item.id" class="bg-white p-3 rounded-xl border border-gray-100 flex items-center justify-between shadow-sm">
                            <div class="flex items-center gap-3">
                                <input type="checkbox" v-model="item.done" @change="updateShoppingItem(item)" class="w-5 h-5 rounded-full border-2 border-gray-200 checked:bg-emerald-500 text-emerald-500">
                                <span :class="{'line-through text-gray-300': item.done}" class="text-sm font-medium">{{ item.text }}</span>
                            </div>
                            <div class="flex gap-2">
                                <button @click="openEditModal(item, 'shopping')" class="bg-emerald-500 text-white p-2.5 rounded-xl shadow-sm active:scale-95 transition" title="Editar"><i data-lucide="edit-3" class="w-4 h-4"></i></button>
                                <button @click="deleteShoppingItem(item.id)" class="bg-red-500 text-white p-2.5 rounded-xl shadow-sm active:scale-95 transition" title="Excluir"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- 3. TASKS / MAINTENANCE / PROJECTS TAB -->
            <section v-if="['tasks', 'maintenance', 'projects'].includes(currentTab)" class="space-y-4">
                
                <div v-if="currentTab === 'maintenance'" class="bg-emerald-50 p-5 rounded-3xl border border-emerald-100 shadow-sm space-y-3">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-2 text-emerald-800">
                            <i data-lucide="info" class="w-5 h-5"></i>
                            <h3 class="font-bold text-sm uppercase tracking-wider">Perfil da Minha Casa</h3>
                        </div>
                        <button @click="isEditingHouse = !isEditingHouse" class="text-emerald-600 text-xs font-bold uppercase tracking-widest bg-white px-3 py-1 rounded-full shadow-sm">
                            {{ isEditingHouse ? 'Cancelar' : (houseDescription ? 'Editar' : 'Descrever') }}
                        </button>
                    </div>

                    <div v-if="isEditingHouse">
                        <textarea v-model="tempHouseDescription" placeholder="Ex: Casa t√©rrea, telhado de barro, piscina, 3 AC..." 
                                  class="w-full bg-white border-none p-3 rounded-2xl text-sm outline-none focus:ring-2 focus:ring-emerald-200 min-h-[100px] shadow-inner"></textarea>
                        <button @click="saveHouseDescription" class="w-full bg-emerald-600 text-white font-bold py-3 rounded-xl mt-2 shadow-md transition active:scale-95 text-xs uppercase tracking-widest">
                            Guardar Perfil
                        </button>
                    </div>
                    <div v-else-if="houseDescription" class="bg-white/50 p-3 rounded-2xl text-xs text-emerald-900 leading-relaxed italic">
                        "{{ houseDescription }}"
                    </div>
                    <div v-else class="text-xs text-emerald-700/60 italic">
                        Descreva a sua casa para que a IA possa sugerir manuten√ß√µes personalizadas.
                    </div>
                </div>

                <div class="bg-white p-4 rounded-2xl border border-gray-200 shadow-sm">
                    <form @submit.prevent="addGeneralItem" class="space-y-3">
                        <div class="flex gap-2">
                            <input v-model="newGeneralTitle" type="text" placeholder="T√≠tulo da tarefa..." class="flex-grow bg-gray-50 border-none p-3 rounded-xl outline-none focus:ring-2 focus:ring-emerald-100 transition" required>
                            <button type="button" @click="refineTaskWithAI" :disabled="loadingAI" class="bg-indigo-600 text-white px-3 rounded-xl shadow-md active:scale-95 transition" title="Sugest√£o IA">
                                <i data-lucide="wand-2" class="w-5 h-5"></i>
                            </button>
                        </div>
                        <div class="flex flex-wrap items-center gap-2">
                            <input v-model="newGeneralDate" type="date" class="bg-gray-50 border-none p-2 rounded-xl text-xs flex-grow outline-none">
                            <select v-model="newGeneralPriority" class="bg-gray-50 border-none p-2 rounded-xl text-xs outline-none font-bold">
                                <option value="Baixa">Baixa</option>
                                <option value="M√©dia">M√©dia</option>
                                <option value="Alta">Alta</option>
                            </select>
                            
                            <label class="bg-gray-50 p-2 rounded-xl cursor-pointer hover:bg-gray-100 transition flex items-center justify-center min-w-[40px]">
                                <input type="file" @change="handleImageUpload" accept="image/*" class="hidden">
                                <i data-lucide="camera" :class="newGeneralImage ? 'text-emerald-500' : 'text-gray-400'" class="w-5 h-5"></i>
                            </label>

                            <button type="submit" class="bg-emerald-600 text-white px-6 py-2 rounded-xl hover:bg-emerald-700 font-bold transition shadow-md">Adicionar</button>
                        </div>
                    </form>
                    
                    <div v-if="currentTab === 'maintenance'" class="mt-4 pt-4 border-t border-gray-100">
                        <button @click="generateMaintenancePlan" :disabled="loadingAI" class="w-full bg-emerald-50 border border-emerald-100 text-emerald-700 py-3 rounded-xl text-xs font-black uppercase tracking-widest flex items-center justify-center gap-2 shadow-sm active:scale-95 transition">
                             <span v-if="loadingAI" class="animate-spin">‚Üª</span>
                             <i v-else data-lucide="clipboard-check" class="w-4 h-4"></i> Gerar Plano IA Preventivo
                        </button>
                    </div>
                </div>

                <div v-for="item in filteredGeneralItems" :key="item.id" 
                    class="bg-white p-4 rounded-2xl border border-gray-200 flex items-start gap-3 shadow-sm transition hover:border-emerald-200">
                    <input type="checkbox" v-model="item.done" @change="updateGeneralItem(item)" class="mt-1 w-5 h-5 rounded-full border-2 border-gray-200 text-emerald-600">
                    
                    <div v-if="item.image" class="w-12 h-12 flex-shrink-0 bg-gray-100 rounded-lg overflow-hidden border">
                        <img :src="item.image" @click="showFullImage(item.image)" class="w-full h-full object-cover cursor-pointer">
                    </div>

                    <div class="flex-grow">
                        <p :class="['font-semibold text-sm', item.done ? 'line-through text-gray-300' : 'text-slate-700']">{{ item.title }}</p>
                        <div class="flex items-center gap-3 mt-1.5">
                            <span v-if="item.date" class="text-[10px] text-emerald-600 font-bold flex items-center gap-1">
                                <i data-lucide="calendar" class="w-3 h-3"></i> {{ formatDate(item.date) }}
                            </span>
                            <span :class="['text-[9px] px-2 py-0.5 rounded-full font-black uppercase tracking-tighter', getPriorityClass(item.priority)]">
                                {{ item.priority }}
                            </span>
                        </div>
                    </div>

                    <div class="flex flex-col gap-2">
                        <button @click="openEditModal(item, 'general')" class="bg-emerald-500 text-white p-2.5 rounded-xl shadow-md active:scale-95 transition" title="Editar"><i data-lucide="edit-3" class="w-4 h-4"></i></button>
                        <button @click="deleteGeneralItem(item.id)" class="bg-red-500 text-white p-2.5 rounded-xl shadow-md active:scale-95 transition" title="Excluir"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                        <button @click="breakdownComplexTask(item)" v-if="!item.done" class="bg-indigo-600 text-white p-2.5 rounded-xl shadow-md active:scale-95 transition" title="Dividir tarefa"><i data-lucide="layers" class="w-4 h-4"></i></button>
                    </div>
                </div>
            </section>
        </main>

        <!-- Modais e Menus -->
        <transition name="fade">
            <div v-if="editingItem" @click.self="editingItem = null" class="fixed inset-0 bg-black/50 z-[80] flex items-center justify-center p-4 backdrop-blur-sm">
                <div class="bg-white w-full max-w-md rounded-3xl p-6 shadow-2xl relative max-h-[90vh] overflow-y-auto text-left">
                    <button @click="editingItem = null" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 p-2"><i data-lucide="x"></i></button>
                    <h2 class="text-xl font-bold mb-4 flex items-center gap-2 text-emerald-800"><i data-lucide="edit-3" class="text-emerald-600"></i> Editar Item</h2>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="text-[10px] font-black uppercase text-gray-400 px-1 tracking-widest">T√≠tulo / Descri√ß√£o</label>
                            <input v-model="editForm.title" type="text" class="w-full bg-gray-50 border-none p-3 rounded-xl mt-1 outline-none focus:ring-2 focus:ring-emerald-100">
                        </div>
                        
                        <div v-if="editForm.origin === 'general'" class="space-y-4">
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="text-[10px] font-black uppercase text-gray-400 px-1 tracking-widest">Data</label>
                                    <input v-model="editForm.date" type="date" class="w-full bg-gray-50 border-none p-3 rounded-xl mt-1 text-sm outline-none">
                                </div>
                                <div>
                                    <label class="text-[10px] font-black uppercase text-gray-400 px-1 tracking-widest">Prioridade</label>
                                    <select v-model="editForm.priority" class="w-full bg-gray-50 border-none p-3 rounded-xl mt-1 text-sm outline-none font-bold">
                                        <option value="Baixa">Baixa</option>
                                        <option value="M√©dia">M√©dia</option>
                                        <option value="Alta">Alta</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div>
                                <label class="text-[10px] font-black uppercase text-gray-400 px-1 tracking-widest">Foto</label>
                                <div class="mt-1 flex items-center gap-4">
                                    <div v-if="editForm.image" class="relative w-24 h-24">
                                        <img :src="editForm.image" class="w-full h-full object-cover rounded-xl border">
                                        <button @click="editForm.image = null" class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full p-1 shadow-md"><i data-lucide="trash-2" class="w-3 h-3"></i></button>
                                    </div>
                                    <label class="w-24 h-24 bg-gray-50 border-2 border-dashed border-gray-200 rounded-xl flex flex-col items-center justify-center cursor-pointer hover:border-emerald-300 transition">
                                        <input type="file" @change="handleEditImageUpload" accept="image/*" class="hidden">
                                        <i data-lucide="camera" class="text-gray-300"></i>
                                        <span class="text-[8px] text-gray-400 mt-1 uppercase font-bold">Alterar</span>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <div v-if="editForm.origin === 'shopping'">
                            <label class="text-[10px] font-black uppercase text-gray-400 px-1 tracking-widest">Categoria</label>
                            <input v-model="editForm.category" type="text" class="w-full bg-gray-50 border-none p-3 rounded-xl mt-1 outline-none focus:ring-2 focus:ring-emerald-100">
                        </div>

                        <button @click="saveEdit" class="w-full bg-emerald-600 text-white font-bold py-4 rounded-2xl hover:bg-emerald-700 transition shadow-lg mt-2 uppercase tracking-widest text-sm">Guardar Altera√ß√µes</button>
                    </div>
                </div>
            </div>
        </transition>

        <transition name="fade">
            <div v-if="previewImage" @click="previewImage = null" class="fixed inset-0 bg-black/90 z-[90] flex items-center justify-center p-4">
                <img :src="previewImage" class="max-w-full max-h-full rounded-lg shadow-2xl">
                <button class="absolute top-6 right-6 text-white bg-white/10 p-4 rounded-full"><i data-lucide="x"></i></button>
            </div>
        </transition>

        <transition name="fade">
            <div v-if="showChat" @click.self="showChat = false" class="fixed inset-0 bg-black/50 z-[70] flex items-end sm:items-center justify-center p-0 sm:p-4 backdrop-blur-sm">
                <div class="bg-white w-full max-w-lg sm:rounded-3xl h-[85vh] flex flex-col shadow-2xl relative">
                    <div class="p-4 border-b flex justify-between items-center bg-emerald-50 sm:rounded-t-3xl text-left">
                        <div class="flex items-center gap-2">
                            <div class="w-8 h-8 bg-emerald-500 rounded-lg flex items-center justify-center text-white"><i data-lucide="bot" class="w-5 h-5"></i></div>
                            <h2 class="font-bold text-emerald-900">Assistente IA</h2>
                        </div>
                        <button @click="showChat = false" class="text-gray-400 hover:text-gray-600 p-2"><i data-lucide="x" class="w-6 h-6"></i></button>
                    </div>
                    <div class="flex-grow overflow-y-auto p-4 space-y-4 bg-gray-50/50 text-left" ref="chatBox">
                        <div v-for="msg in chatMessages" :key="msg.id" :class="['flex', msg.role === 'user' ? 'justify-end' : 'justify-start']">
                            <div :class="['chat-bubble p-3.5 rounded-2xl text-sm shadow-sm whitespace-pre-wrap', msg.role === 'user' ? 'bg-emerald-600 text-white rounded-tr-none' : 'bg-white text-slate-700 rounded-tl-none border border-gray-100']">
                                {{ msg.text }}
                            </div>
                        </div>
                        <div v-if="chatLoading" class="flex justify-start">
                            <div class="bg-white p-3 rounded-xl rounded-tl-none border border-gray-100 flex gap-1"><span class="w-1.5 h-1.5 bg-emerald-300 rounded-full animate-bounce"></span><span class="w-1.5 h-1.5 bg-emerald-300 rounded-full animate-bounce delay-100"></span><span class="w-1.5 h-1.5 bg-emerald-300 rounded-full animate-bounce delay-200"></span></div>
                        </div>
                    </div>
                    <div class="p-4 border-t bg-white sm:rounded-b-3xl">
                        <form @submit.prevent="sendChatMessage" class="flex gap-2">
                            <input v-model="chatInput" type="text" placeholder="Pergunte algo..." class="flex-grow bg-gray-50 border-none p-3 rounded-xl outline-none focus:ring-2 focus:ring-emerald-50 transition">
                            <button type="submit" class="bg-emerald-600 text-white p-3 rounded-xl shadow-md hover:bg-emerald-700 transition"><i data-lucide="send" class="w-5 h-5"></i></button>
                        </form>
                    </div>
                </div>
            </div>
        </transition>

        <transition name="fade">
            <div v-if="showSettings" @click.self="showSettings = false" class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 backdrop-blur-sm">
                <div class="bg-white rounded-3xl p-6 w-full max-w-md shadow-2xl relative text-left">
                    <button @click="showSettings = false" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 p-2"><i data-lucide="x"></i></button>
                    <div class="flex items-center gap-2 mb-6 text-emerald-800"><i data-lucide="settings" class="text-emerald-600"></i><h2 class="text-xl font-bold">Op√ß√µes</h2></div>
                    <div class="space-y-6">
                        <div>
                            <label class="block text-[10px] font-black text-gray-400 uppercase mb-2 tracking-widest">Google Gemini API Key</label>
                            <input v-model="tempApiKey" type="password" class="w-full bg-gray-50 border-none p-3 rounded-xl mb-2 outline-none focus:ring-2 focus:ring-emerald-100 transition">
                            <button @click="saveApiKey" class="w-full bg-emerald-600 text-white py-3 rounded-xl text-xs font-bold shadow-sm transition hover:bg-emerald-700 uppercase tracking-widest">Actualizar Chave</button>
                        </div>
                        <div class="border-t pt-4">
                            <button @click="clearDatabase" class="w-full text-red-600 text-xs font-bold border border-red-50 py-3 rounded-xl hover:bg-red-50 transition uppercase tracking-widest">Apagar todos os dados</button>
                        </div>
                    </div>
                </div>
            </div>
        </transition>

        <!-- Barra Inferior -->
        <nav class="bg-white border-t border-gray-100 fixed bottom-0 w-full flex justify-around items-center p-3 z-[60] shadow-up">
            <button v-for="tab in tabs" :key="tab.id" @click="currentTab = tab.id"
                :class="['flex flex-col items-center gap-1 transition-all flex-1', currentTab === tab.id ? 'text-emerald-600 scale-110 font-bold' : 'text-gray-400']">
                <i :data-lucide="tab.icon" class="w-6 h-6"></i>
                <span class="text-[9px] font-black uppercase tracking-tighter">{{ tab.name }}</span>
            </button>
        </nav>
    </div>

    <script>
        const { createApp, ref, computed, onMounted, watchEffect, nextTick } = Vue;

        const db = new Dexie("HomeManagerV10");
        db.version(10).stores({
            shopping: "++id, text, category, done",
            general: "++id, title, type, priority, date, done, image",
            config: "key, value"
        });

        createApp({
            setup() {
                const loading = ref(true);
                const currentTab = ref('home');
                const tabs = [
                    { id: 'home', name: 'In√≠cio', icon: 'layout-grid' },
                    { id: 'shopping', name: 'Compras', icon: 'shopping-basket' },
                    { id: 'tasks', name: 'Tarefas', icon: 'list-checks' },
                    { id: 'maintenance', name: 'Manuten√ß√£o', icon: 'wrench' },
                    { id: 'projects', name: 'Projetos', icon: 'hammer' }
                ];

                const newItem = ref('');
                const shoppingList = ref([]);
                const generalItems = ref([]);
                const loadingAI = ref(false);
                const toast = ref(null);
                const showSettings = ref(false);
                const showApiOverlay = ref(false);
                const apiKeyStored = ref(null);
                const tempApiKey = ref('');
                const previewImage = ref(null);

                const houseDescription = ref('');
                const tempHouseDescription = ref('');
                const isEditingHouse = ref(false);

                const editingItem = ref(null);
                const editForm = ref({ id: null, title: '', priority: 'M√©dia', date: '', category: '', image: '', origin: '' });

                const newGeneralTitle = ref('');
                const newGeneralPriority = ref('M√©dia');
                const newGeneralDate = ref('');
                const newGeneralImage = ref(null);

                const showChat = ref(false);
                const chatInput = ref('');
                const chatLoading = ref(false);
                const chatMessages = ref([{ id: 1, role: 'bot', text: 'Ol√°! Sou o seu assistente inteligente. Como posso ajudar na organiza√ß√£o hoje?' }]);
                const chatBox = ref(null);

                const showToast = (msg) => {
                    toast.value = msg;
                    setTimeout(() => toast.value = null, 3000);
                };

                const compressImage = (file) => {
                    return new Promise((resolve) => {
                        const reader = new FileReader();
                        reader.readAsDataURL(file);
                        reader.onload = (event) => {
                            const img = new Image();
                            img.src = event.target.result;
                            img.onload = () => {
                                const canvas = document.createElement('canvas');
                                const MAX_WIDTH = 600;
                                const scaleSize = MAX_WIDTH / img.width;
                                canvas.width = MAX_WIDTH;
                                canvas.height = img.height * scaleSize;
                                const ctx = canvas.getContext('2d');
                                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                                resolve(canvas.toDataURL('image/jpeg', 0.6));
                            };
                        };
                    });
                };

                const handleImageUpload = async (e) => {
                    const file = e.target.files[0];
                    if (file) newGeneralImage.value = await compressImage(file);
                };

                const handleEditImageUpload = async (e) => {
                    const file = e.target.files[0];
                    if (file) editForm.value.image = await compressImage(file);
                };

                const showFullImage = (url) => { previewImage.value = url; };

                const loadSettings = async () => {
                    const keyConfig = await db.config.get('gemini_api_key');
                    if (keyConfig) {
                        apiKeyStored.value = keyConfig.value;
                        tempApiKey.value = keyConfig.value;
                    } else {
                        showApiOverlay.value = true;
                    }

                    const houseConfig = await db.config.get('house_description');
                    if (houseConfig) {
                        houseDescription.value = houseConfig.value;
                        tempHouseDescription.value = houseConfig.value;
                    }
                    loading.value = false;
                };

                const saveApiKey = async () => {
                    if (!tempApiKey.value) return;
                    await db.config.put({ key: 'gemini_api_key', value: tempApiKey.value });
                    apiKeyStored.value = tempApiKey.value;
                    showApiOverlay.value = false;
                    showSettings.value = false;
                    showToast("IA Ativada!");
                };

                const saveHouseDescription = async () => {
                    await db.config.put({ key: 'house_description', value: tempHouseDescription.value });
                    houseDescription.value = tempHouseDescription.value;
                    isEditingHouse.value = false;
                    showToast("Perfil da casa guardado!");
                };

                const callGeminiRaw = async (prompt, jsonSchema = null) => {
                    if (!apiKeyStored.value) { showApiOverlay.value = true; return null; }
                    try {
                        const payload = { contents: [{ parts: [{ text: prompt }] }] };
                        if (jsonSchema) payload.generationConfig = { responseMimeType: "application/json", responseSchema: jsonSchema };
                        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKeyStored.value}`, {
                            method: 'POST', body: JSON.stringify(payload)
                        });
                        const data = await response.json();
                        const text = data.candidates?.[0]?.content?.parts?.[0]?.text;
                        return jsonSchema ? JSON.parse(text) : text;
                    } catch (err) {
                        showToast("Falha na IA.");
                        return null;
                    }
                };

                const suggestRecipes = async () => {
                    if (shoppingList.value.length < 2) return showToast("Adicione ingredientes √† lista primeiro.");
                    loadingAI.value = true;
                    const items = shoppingList.value.filter(i => !i.done).map(i => i.text).join(", ");
                    const prompt = `Com base nestes ingredientes: [${items}], sugira 2 receitas r√°pidas. Indique o nome e um resumo de 2 linhas. Responda em Portugu√™s.`;
                    const reply = await callGeminiRaw(prompt);
                    loadingAI.value = false;
                    if (reply) {
                        chatMessages.value.push({ id: Date.now(), role: 'bot', text: `Sugest√µes de Refei√ß√£o:\n\n${reply}` });
                        showChat.value = true;
                    }
                };

                const breakdownComplexTask = async (item) => {
                    loadingAI.value = true;
                    const prompt = `Divida a tarefa "${item.title}" em 4 subtarefas pr√°ticas e curtas. Responda apenas com o JSON.`;
                    const res = await callGeminiRaw(prompt, {
                        type: "OBJECT",
                        properties: { subtasks: { type: "ARRAY", items: { type: "STRING" } } }
                    });
                    loadingAI.value = false;
                    if (res?.subtasks) {
                        for (const sub of res.subtasks) {
                            await db.general.add({
                                title: `${sub} (de: ${item.title})`,
                                type: item.type,
                                priority: 'Baixa',
                                date: item.date,
                                done: false
                            });
                        }
                        await loadGeneral();
                        showToast("Tarefa desdobrada!");
                    }
                };

                const houseHealth = computed(() => {
                    const totalTasks = generalItems.value.length;
                    if (totalTasks === 0) return 100;
                    const completedTasks = generalItems.value.filter(i => i.done).length;
                    return Math.round((completedTasks / totalTasks) * 100);
                });

                const houseHealthMessage = computed(() => {
                    if (houseHealth.value === 100) return "Tudo em dia! Casa perfeita.";
                    if (houseHealth.value > 70) return "Bom estado. Algumas tarefas pendentes.";
                    return "Aten√ß√£o necess√°ria. Muitas pend√™ncias.";
                });

                const highPriorityItems = computed(() => 
                    generalItems.value.filter(i => i.priority === 'Alta' && !i.done)
                );

                const upcomingItems = computed(() => {
                    return generalItems.value
                        .filter(i => i.date && !i.done)
                        .sort((a, b) => new Date(a.date) - new Date(b.date));
                });

                const suggestMissingItems = async () => {
                    if (shoppingList.value.length < 2) return showToast("Adicione mais itens antes.");
                    loadingAI.value = true;
                    const items = shoppingList.value.map(i => i.text).join(", ");
                    const prompt = `Analise esta lista de compras: [${items}]. Sugira 4 itens l√≥gicos que podem estar faltando. Responda apenas com o JSON.`;
                    const res = await callGeminiRaw(prompt, {
                        type: "OBJECT",
                        properties: { suggestions: { type: "ARRAY", items: { type: "STRING" } } }
                    });
                    loadingAI.value = false;
                    if (res?.suggestions) {
                        const msg = `Baseado na sua lista, pode ter esquecido: ${res.suggestions.join(", ")}.`;
                        chatMessages.value.push({ id: Date.now(), role: 'bot', text: msg });
                        showChat.value = true;
                    }
                };

                const generateMaintenancePlan = async () => {
                    loadingAI.value = true;
                    const today = new Date().toISOString().split('T')[0];
                    const context = houseDescription.value ? `Contexto da casa: ${houseDescription.value}.` : "";
                    const prompt = `${context} Gere um plano de manuten√ß√£o preventiva residencial partindo de hoje (${today}). Sugira 5 tarefas essenciais para os pr√≥ximos 6 meses. Responda apenas com o JSON.`;
                    const schema = {
                        type: "OBJECT",
                        properties: {
                            tasks: { type: "ARRAY", items: { type: "OBJECT", properties: { title: { type: "STRING" }, priority: { type: "STRING" }, date: { type: "STRING" } } } }
                        }
                    };
                    const res = await callGeminiRaw(prompt, schema);
                    loadingAI.value = false;
                    if (res?.tasks) {
                        for (const task of res.tasks) {
                            await db.general.add({ title: task.title, type: 'maintenance', priority: task.priority || 'M√©dia', date: task.date || today, done: false });
                        }
                        await loadGeneral();
                        showToast("Plano gerado!");
                    }
                };

                const refineTaskWithAI = async () => {
                    if (!newGeneralTitle.value) return showToast("Digite o t√≠tulo.");
                    loadingAI.value = true;
                    const prompt = `Tarefa: "${newGeneralTitle.value}". Sugira prioridade (Alta, M√©dia ou Baixa) e uma data pr√≥xima (YYYY-MM-DD). JSON apenas.`;
                    const res = await callGeminiRaw(prompt, {
                        type: "OBJECT",
                        properties: { priority: { type: "STRING" }, date: { type: "STRING" } }
                    });
                    loadingAI.value = false;
                    if (res) {
                        newGeneralPriority.value = res.priority || 'M√©dia';
                        newGeneralDate.value = res.date || '';
                        showToast("Sugest√£o aplicada.");
                    }
                };

                const loadShopping = async () => { shoppingList.value = await db.shopping.toArray(); };
                const addItem = async () => {
                    if (!newItem.value) return;
                    await db.shopping.add({ text: newItem.value, category: 'Outros', done: false });
                    newItem.value = '';
                    await loadShopping();
                };
                const updateShoppingItem = async (item) => await db.shopping.update(item.id, { done: item.done });
                const deleteShoppingItem = async (id) => { await db.shopping.delete(id); await loadShopping(); };

                const categorizeAll = async () => {
                    const uncat = shoppingList.value.filter(i => i.category === 'Outros' || i.category === 'Aguardando IA');
                    if (uncat.length === 0) return showToast("Sem novos itens.");
                    loadingAI.value = true;
                    const itemsText = uncat.map(i => i.text).join(', ');
                    const res = await callGeminiRaw(`Categorize: ${itemsText}`, {
                        type: "OBJECT",
                        properties: { results: { type: "ARRAY", items: { type: "OBJECT", properties: { text: { type: "STRING" }, category: { type: "STRING" } } } } }
                    });
                    if (res?.results) {
                        for (const r of res.results) {
                            const found = uncat.find(i => i.text === r.text);
                            if (found) await db.shopping.update(found.id, { category: r.category });
                        }
                    }
                    loadingAI.value = false;
                    await loadShopping();
                };

                const copyShoppingList = () => {
                    let text = "üõí LISTA DE COMPRAS:\n\n";
                    Object.entries(categorizedShopping.value).forEach(([cat, items]) => {
                        text += `--- ${cat.toUpperCase()} ---\n` + items.map(i => `${i.done ? '[X]' : '[ ]'} ${i.text}`).join('\n') + "\n\n";
                    });
                    navigator.clipboard.writeText(text);
                    showToast("Lista copiada!");
                };

                const categorizedShopping = computed(() => {
                    const groups = {};
                    shoppingList.value.forEach(item => { (groups[item.category] = groups[item.category] || []).push(item); });
                    return groups;
                });

                const loadGeneral = async () => { generalItems.value = await db.general.toArray(); };
                const addGeneralItem = async () => {
                    if (!newGeneralTitle.value) return;
                    await db.general.add({ title: newGeneralTitle.value, type: currentTab.value, priority: newGeneralPriority.value, date: newGeneralDate.value, done: false, image: newGeneralImage.value });
                    newGeneralTitle.value = ''; newGeneralDate.value = ''; newGeneralImage.value = null;
                    await loadGeneral();
                };
                const updateGeneralItem = async (item) => await db.general.update(item.id, { done: item.done });
                const deleteGeneralItem = async (id) => { await db.general.delete(id); await loadGeneral(); };
                const filteredGeneralItems = computed(() => generalItems.value.filter(i => i.type === currentTab.value));

                const openEditModal = (item, origin) => {
                    editForm.value = { id: item.id, title: origin === 'shopping' ? item.text : item.title, priority: item.priority || 'M√©dia', date: item.date || '', category: item.category || '', image: item.image || '', origin: origin };
                    editingItem.value = true;
                };

                const saveEdit = async () => {
                    if (editForm.value.origin === 'shopping') {
                        await db.shopping.update(editForm.value.id, { text: editForm.value.title, category: editForm.value.category });
                        await loadShopping();
                    } else {
                        await db.general.update(editForm.value.id, { title: editForm.value.title, priority: editForm.value.priority, date: editForm.value.date, image: editForm.value.image });
                        await loadGeneral();
                    }
                    editingItem.value = null;
                    showToast("Salvo!");
                };

                const formatDate = (d) => new Date(d).toLocaleDateString('pt-PT', { timeZone: 'UTC' });
                const formatDateShort = (d) => {
                    if (!d) return '';
                    const dt = new Date(d);
                    return dt.toLocaleDateString('pt-PT', { day: '2-digit', month: '2-digit', timeZone: 'UTC' });
                };
                const getPriorityClass = (p) => p === 'Alta' ? 'bg-red-100 text-red-700' : p === 'M√©dia' ? 'bg-amber-100 text-amber-700' : 'bg-blue-100 text-blue-700';

                const exportToCalendar = (item) => {
                    const start = item.date.replace(/-/g, '');
                    const ics = `BEGIN:VCALENDAR\nVERSION:2.0\nBEGIN:VEVENT\nDTSTART:${start}T090000Z\nSUMMARY:${item.title}\nEND:VEVENT\nEND:VCALENDAR`;
                    const blob = new Blob([ics], { type: 'text/calendar' });
                    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `agenda.ics`; a.click();
                    showToast("Exportado!");
                };

                const sendChatMessage = async () => {
                    if (!chatInput.value) return;
                    const text = chatInput.value;
                    chatMessages.value.push({ id: Date.now(), role: 'user', text });
                    chatInput.value = ''; chatLoading.value = true;
                    await nextTick(); chatBox.value.scrollTop = chatBox.value.scrollHeight;
                    const reply = await callGeminiRaw(`Aja como assistente dom√©stico inteligente. Responda curto em Portugu√™s: ${text}`);
                    chatLoading.value = false;
                    if (reply) {
                        chatMessages.value.push({ id: Date.now() + 1, role: 'bot', text: reply });
                        await nextTick(); chatBox.value.scrollTop = chatBox.value.scrollHeight;
                    }
                };

                const exportData = async () => {
                    const data = { shopping: await db.shopping.toArray(), general: await db.general.toArray(), house: houseDescription.value };
                    const blob = new Blob([JSON.stringify(data)], { type: 'application/json' });
                    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'backup.json'; a.click();
                };

                const clearDatabase = async () => {
                    if (confirm("Apagar tudo?")) { await db.delete(); window.location.reload(); }
                };

                onMounted(() => {
                    loadSettings(); loadShopping(); loadGeneral();
                    watchEffect(() => { setTimeout(() => lucide.createIcons(), 100); }, { flush: 'post' });
                });

                return {
                    loading, currentTab, tabs, newItem, shoppingList, generalItems, loadingAI, toast, showSettings, showApiOverlay, tempApiKey, saveApiKey,
                    categorizedShopping, addItem, updateShoppingItem, deleteShoppingItem, categorizeAll, copyShoppingList,
                    newGeneralTitle, newGeneralPriority, newGeneralDate, newGeneralImage, filteredGeneralItems, addGeneralItem, updateGeneralItem, deleteGeneralItem,
                    editingItem, editForm, openEditModal, saveEdit, handleImageUpload, handleEditImageUpload, previewImage, showFullImage,
                    highPriorityItems, upcomingItems, formatDate, formatDateShort, getPriorityClass, exportToCalendar,
                    showChat, chatInput, chatMessages, chatLoading, sendChatMessage, chatBox, exportData, clearDatabase,
                    suggestMissingItems, refineTaskWithAI, generateMaintenancePlan, suggestRecipes, breakdownComplexTask, houseHealth, houseHealthMessage,
                    houseDescription, tempHouseDescription, isEditingHouse, saveHouseDescription
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
